## 1. 功能描述

**磁盘引导块程序, 驻留在磁盘第一个扇区中**. BIOS会将这个内容加载到内存地址0x7c00处并执行. 

在bootsect执行期间, 它将自己移动到内存绝对地址0x90000开始处并继续执行. 

BIOS设置的中断0x1E的中断向量值是软驱参数表地址. 

主要作用是首先把从磁盘第2个扇区开始的4个扇区的**setup模块**(setup.S编译而成)加载到内存紧接着bootsect后面位置(0x90200). 

然后**利用BIOS中断0x13取磁盘参数表中当前启动引导盘的参数**, 接着在屏幕上显示“Loading system...”字符串. 

再把磁盘上setup模块后面的system模块加载到内存0x10000开始的地方. 

随后确定根文件系统的设备号, 若没有指定, 则根据**BIOS所保存的引导盘的每磁道扇区数判别盘的类型和种类(如1.44MB A盘)并**保存其设备号于root\_dev(508地址)中, 最后长跳转到setup程序开始处(0x90200)中**执行setup程序**. 

在磁盘上, 引导块、setup模块和system模块的扇区位置和大小如图. 

![config](images/3.png)

图中显示Linux 0.12内核**在1.44MB磁盘上所占扇区分布情况**. 1.44MB磁盘盘片两面各有80个磁道(柱面), 每磁道18扇区, 共2880个扇区. 引导程序占用第1个扇区, setup模块占随后4个, system模块占大约随后260个扇区. 剩余空间可存放一个基本的根文件系统. 

文件名后缀是大写的S. 使用这样的后缀可以让as使用GNU C编译器的与处理功能. 因此可以在汇编中包括#include、#if等. 

## 2. 代码注释

root_dev定义在引导扇区508, 509字节处, 指根文件系统所在设备号. 0x0306指第2个硬盘第1个分区. 这里默认为0x0306是因为当时 Linus 开发Linux系统时是在第2个硬盘第1个分区中存放根文件系统. 这个值需要根据你自己根文件系统所在硬盘和分区进行修改. 例如, 如果你的根文件系统在第1个硬盘的第1个分区上, 那么该值应该为0x0301, 即(0x01, 0x03). 如果根文件系统是在第2个Bochs软盘上, 那么该值应该为0x021D, 即(0x1D,0x02). 当编译内核时, 你可以在Makefile文件中另行指定你自己的值, 内核映像文件Image的创建程序tools/build会使用你指定的值来设置你的根文件系统所在设备号. 

## 3. 其他信息

### 3.1 Linux 0.12硬盘设备号

0.12中硬盘设备命令方式. 设备的主设备号分别是1-内存, 2-磁盘, 3-硬盘, 4-ttyx, 5-tty, 6-并行口, 7-非命令管道. 由于1个硬盘还可以有1\~4个分区, 因此硬盘还根据分区不同用次设备号进行指定分区. 所以硬盘的逻辑设备号由: 设备号=主设备号X256 + 次设备号. 两个硬盘的所有逻辑设备号如下表. 

![config](images/4.png)

0x300和0x305代表整个硬盘. Linux 0.95后已经不适用这种命名方式了, 而是和现在的命名方法相同. 

### 3.2 从硬盘启动系统

若需要从硬盘设备启动系统, 那么通常需要使用其他多操作系统引导程序来引导. 例如LILO、GRUB等. 此时bootsect.S所完成的任务由这些程序完成. **bootsect就不会执行了(所以现在的Linux已经没有这个了)**. 因为如果从硬盘启动系统, 那么通常内核映像文件Image会存在在活动分区的根文件系统中. 因此需要知道**内核映像文件Image在文件系统中的位置**以及是**什么文件系统**. 即**引导扇区程序需要能够识别并访问文件系统**, 从中**读取内核映像文件**. 

从硬盘启动的基本流程: 系统上电, 可启动硬盘的第一个扇区(主引导记录MBR, Master Boot Record)会被BIOS加载到内存0x7c00处并开始执行. 该程序首先把自己下移到内存0x600处, 然后根据MBR中分区表信息所指明活动分区中的第1个扇区(引导扇区)加载到内存0x7c00, 然后执行. 如果直接使用这种方式来引导系统就会碰到这样一个问题, 即文件系统不能与内核映像文件Image共存. 

一种方法是专门设置一个小容量的活动分区来存放内核映像Image. 而相应的根文件系统放在另一个分区中. 这样虽然浪费了硬盘的4个主分区之一, 但应该能在对bootsect.S做最少修改前提下做到从硬盘启动. 

另一个办法是把内核映像文件Image和根文件系统组合存放在一个分区中, 即内核映像文件Image放在分区开始的一些扇区中, 而根文件系统则从随后某一指定扇区开始存放. 