许多计算机化的活动都是由定时测量(timing measurement)来驱动的，比如计算机休眠归因于定时器. 定时机制连同一些更可见的内核活动(如检查超时)来驱使进程切换. 

内核必须完成两种重要的定时测量: 

- 保存当前的时间和日期，以便通过系统调用返回给用户程序，也可由内核本身把当前时间作为文件和网络包的时间戳；

- 维持定时器，这能告诉内核或用户程序某一段时间间隔已经过去. 
 
定时测量由基于**固定频率振荡器**和**计数器**的几个硬件电路完成. 

在80X86体系结构中，内核必须显式地与几种时钟(clock)和定时器(timer)电路打交道. 时钟电路用于跟踪当前时间和产生精确的时间度量. 定时器电路由内核进行编程，所以以固定的、预先定义的频率发出中断. 该周期性中断对实现内核和用户程序使用的软定时器很重要. 

下面描述IBM兼容PC上的时钟和硬件电路. 

## 实时时钟(RTC)

所有的PC都包含RTC(Real Time Clock，实时时钟)，它独立于CPU和所有其他芯片. 

电脑关机，RTC也正常工作，它靠一个小电池或蓄电池供电. CMOS RAM和RTC集成在一个芯片. 

RTC在IRQ8上产生周期性中断，频率2 ~ 8192HZ；也可对其编程，当RTC到达某个特定值激活IRQ8. 

Linux只用RTC来获取时间和日期，也允许通过对/dev/rtc对RTC进行编程. Kernel通过0x70和0x71 I/O端口访问RTC，从而可以设置闹钟. 

## 时间戳计数器(TSC)

80x86上的微处理器都有CLK输入针脚，从奔腾系列开始，微处理器支持一个计数器，每当一个时钟信号来的时候，计数器加1，可以通过汇编指令rdtsc来得到计数器的值. 

Linux在初始化时候必须确定时钟信号的频率，但是内核不会声明这个频率，所以同一个内核映像可运行在产生任何时钟频率的CPU上. 

通过calibrate_tsc可以获得CPU的频率，它是通过计算大约5毫秒里tsc寄存器里面的增加值来确认的. 或者可以通过cat /proc/cpuinfo来获取cpu频率. tsc可以提供比PIT更精确的时间度量. 

## 可编程间隔定时器(PIT)

除了RTC和TSC，IBM兼容PC还包含了可编程间隔定时器(Programmable internval timer，PIT). PIT类似微波炉的闹钟机制，当时间到的时候，提供铃声，PIT不是产生铃声，而是产生一种特殊中断，叫定时器中断或者时钟中断. 它用来告诉内核一个间隔过去了. 这个时间间隔也叫做一个滴答数. PIT永远以**内核确定的固定频率**不停发出中断. 

如内核频率设为1000HZ,则时间间隔或滴答为1/1000=1微秒. 滴答越短，定时精度更高，但是用户模式的时间更短，也就是说用户模式下程序执行会越慢. 滴答的长度以纳秒形式存在tick_nsec变量里面. 每个IBM兼容PC至少包含一个PIT，PIT通常通过8254 CMOS芯片的0x40--0x43端口来访问. 它产生中断号为IRQ 0. 

下面是关于pIT里面的一些宏定义: 

HZ: 每秒中断数. 

CLOCK_TICK_RATE:值是1,193,182，它是8254芯片内部振荡器频率. 

LATCH: 代表CLOCK_TICK_RATE和HZ的比率，被用来编程PIT. 

## CPU本地定时器

最近的80x86架构的微处理器上的local apic提供了cpu local timer.他和pit区别在于它提供了one-shot和periodic中断. 它可以使中断发送到特定cpu. one-shot中断常用在实时系统里面. 

## 高精度事件定时器(HPET)

HPET(High Precision Event Timer) 称高精度定时器(到时了产生中断)是Intel和MS开发的一种新型定时器芯片，最低时钟频率为10MHZ，而且定义了比较严格的精确度. 

HPET是指一组可被内核使用的定时器，最多可扩展为8个block，而每个block最多可有32个可编程的timer,也就是最多可以实现256个timer共同工作. 

**每一个block** 都会有一个**主定时计数器**(该计数器可以由自己的时钟信号驱动)，以及最多32个逻辑比较器，及最多32个匹配寄存器. 主定时计数器会时时刻刻产生嘀嗒，而一个比较器与一个比较寄存器组和起来就形成了一个timer(当然还有一些配置寄存器). 

可以编程添入一个期望的值到比较寄存器中，当经过一定的时间，比较器判断主计数器与比较寄存器的值相同便产生了一个中断(中断发往哪里也是可以编程的). 当然每个timer都可配置为周期时钟或是非周期时钟的. 而且HPET可以通过配置来代替古老的PIT(8254)及RTC时钟的. 

HPET 精确度高而且灵活. 

## ACPI电源管理定时器

ACPI PMT是另一种时钟设备，包含在几乎所有基于ACPI的主板上，时钟信号拥有大约3.58MHz的固定频率. 该设备实际上是个计数器，每个时钟节拍到来增加一次. 为读取计数器当前值，内核需要访问某个I/O端口，该端口地址由BIOS在初始化阶段确定. 