
计算机系统有很多外设需要服务，显然，轮询的方式是非常浪费CPU的计算资源的，尤其是对于那些并不是频繁需要服务的设备。因此，工程师们设计了外设主动向CPU发起服务请求的方式，这种方式就是中断。采用中断方式后，在没有外设请求时，CPU可以继续其他计算任务，而不是进行很多不必要的轮询，极大地提高了系统的吞吐。在每个指令周期结束后，如果CPU的状态标志寄存器中的IF（interrupt flag）位为1，那么CPU会去检查是否有中断请求，如果有中断请求，则运行对应的中断服务程序，然后返回被中断的计算任务继续执行。

# 可编程中断控制器 8259A

CPU不可能为每个硬件都设计专门的管脚接收中断，管脚数量的限制、电路的复杂度、灵活度等方方面面都不允许，因此，计算机工程师们设计了一个专门管理中断的芯片，接收来自外围设备的请求，确定请求的优先级，并向CPU发出中断。1981年IBM推出的第一代个人电脑PC/XT使用了一个独立的8259A作为中断控制器，自此，8259A就成了单核时代中断芯片事实上的标准。因为中断控制器可以通过软件编程进行控制，比如当管脚收到设备信号时，可以编程控制其发出的中断向量号，所以中断控制器又称为可编程中断控制器（programmable interrupt controller），简称PIC。单片8259A可以连接8个外设的中断信号线，可以多片级联支持更多外设。

8259A 的内部逻辑结构如图3-5所示。

![2024-03-04-18-59-38.png](./images/2024-03-04-18-59-38.png)

当中断源请求服务时，需要记录中断请求，8259A的中断请求寄存器IRR负责接收并锁存来自IR0～IR7的中断请求信号。

系统软件可以通过编程设置8259A的寄存器IMR来屏蔽中断，比如将IMR的第0位设置为1，那么8259A将不再响应IR0连接的外设的中断请求。与CPU通过cli命令关中断相比，这个屏蔽是彻底的屏蔽。当CPU通过cli命令关中断后，8259A还会将中断发送给CPU，只是CPU不处理中断而已，而如果设置了8259A屏蔽中断，那么8259A将忽略外设中断请求，更不会向CPU发送中断信号。

当CPU开始响应中断时，其将向8259A发送INTA信号，通知8259A中断处理开始了，8259A会在中断服务寄存器ISR中将CPU正在处理的中断记录下来。当CPU的中断服务程序处理完中断后，将向8259A发送EOI信号，告知8259A中断处理完毕，8259A会复位ISR中对应的位。8259A记录CPU正在服务的中断的目的之一是当后续收到新的中断时，8259A将比较新的中断和正在处理的中断的优先级，决定是否打断CPU正在服务的中断。如果8259A工作在AEOI模式，那么8259A会自动复位ISR。

在向CPU发送中断信号前，8259A需要从IRR中挑选出优先级最高的中断。如果CPU正在处理中断，那么还要与CPU正在处理的中断进行优先级比较。8259A中的中断优先级判别单元（priority resolver）负责完成以上任务。

8259A和CPU的连接如图3-6所示.

![2024-03-04-19-01-43.png](./images/2024-03-04-19-01-43.png)

片选和地址译码器相连，当CPU准备访问8259A时，需要向地址总线发送8259A对应的地址，经过译码器后，译码器发现是8259A对应的地址，因此会拉低与8259A的CS连接的管脚的电平，从而选中8259A。

8259A的D0～7管脚与CPU的数据总线相连。从CPU向8259A发送ICW和OCW，以及从8259A向CPU传送8259A的状态以及中断向量号，都是通过数据总线传递的。

当CPU向8259A发送ICW、OCW时，在将数据送上数据总线后，需要通知8259A读数据，CPU通过拉低WR管脚的电平的方式通知8259A。当8259A的WR管脚收到低电平后，读取数据总线的数据。类似的，CPU准备好读取8259A的状态时，拉低RD管脚，通知8259A向处理器发送数据。

8259A的管脚INTR（interrupt request）和INTA（interrupt acknowledge）分别与处理器的INTR和INTA管脚相连。8259A通过管脚 INTR 向CPU发送中断请求，CPU通过管脚INTA向PIC发送中断确认，告诉 PIC 其收到中断并且开始处理了。

操作系统会将中断对应的服务程序地址等信息存储在一个数组中，数组中的每一个元素对应一个中断。在实模式下，这个数组称为IVT(interrupt vector table)。在保护模式下，这个数组称为IDT（Interrupt descriptor table）。在响应中断时，CPU使用中断向量从IVT/IDT中索引中断服务程序。但是，x86体系约定，前32个中断号（0～31）是留给处理器自己使用的，比如第0个中断号是处理器出现除0异常的，因此，外设的中断向量只能从32号中断开始。所以，在初始化8259A时，操作系统通常会设置8259A的中断向量从32号中断开始，因此当8259A收到管脚IR0的中断请求时，其将向CPU发出的中断向量是32，当收到管脚IR1的中断请求时，其将向CPU发出的中断向量是33，以此类推。在CPU初始化8259A时，通过第2个初始化命令字（ICW2）设置8259A起始中断向量号，下面代码中的变量irq_base记录的就是起始中断向量号：

```cpp

```

后来，随着APIC和MSI的出现，中断向量设置得更为灵活，可以为每个PCI设备设置其中断向量，这个中断向量存储在PCI设备的配置空间中。

内核中抽象了一个结构体kvm_kpic_state来记录每个8259A的状
态:

