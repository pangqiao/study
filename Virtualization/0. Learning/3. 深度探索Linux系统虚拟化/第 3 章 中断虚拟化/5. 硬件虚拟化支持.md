
最初，虚拟中断芯片是在用户空间实现的，但是中断芯片密集地参与了整个计算机系统的运转过程，因此，为了减少内核空间和用户空间之间的上下文切换带来的开销，后来，中断芯片的虚拟实现在了内核空间。为了进一步提高效率，Intel从硬件层面对虚拟化的方方面面进行了支持，这一节，我们就来讨论Intel在硬件层面对中断虚拟化的支持。

在前面讨论完全基于软件虚拟中断芯片的方案中，我们看到，向 Guest 注入中断的时机都是在VM entry那一刻，因此，如果要向 Guest 注入中断，必须要触发一次VM exit，这是中断虚拟化的主要开销。因此，为了避免这次Host模式和Guest模式的切换，Intel在硬件层面从如下3个方面进行了支持：

1）virtual-APIC page。我们知道，在物理上，LAPIC有一个 4KB 大小的页面APIC page，用来保存寄存器的值。Intel在CPU的Guest模式下实现了一个用于存储中断寄存器的virtual-APIC page。在 Guest 模式下有了状态，后面Guest模式下还有了中断逻辑，很多中断行为就无须VMM介入了，从而大大地减少了VM exit的次数。当然有些写中断寄存器的操作是具有副作用的，比如通过写ICR寄存器发送IPI中断，这时就需要触发VM exit。

2）Guest模式下的中断评估逻辑。Intel在Guest模式中实现了部分中断芯片的逻辑用于中断评估，当有中断发生时，CPU不必再退出到Host模式，而是直接在Guest模式下完成中断评估。

