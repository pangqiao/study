
当 I/O 端口或 MMIO 访问被捕获时, ACRN Hypervisor 首先检查要访问的地址是否落在任何注册的处理程序的范围内, 如果这样的处理程序存在, 则调用该处理程序.

# I/O 处理程序管理

在 ACRN Hypervisor 中, 每个 VM 都有两个 I/O 处理程序列表, 一个用于 I/O 端口, 另一个用于 MMIO. 列表中的每个元素都包含一个内存范围和一个指向处理程序的函数指针, 该处理程序模拟落在该范围内的访问.

I/O 处理程序在 VM 创建时被注册, 并且在该 VM 被销毁之前从未更改. VM 被销毁时, 它的 I/O 处理程序会被取消注册. 如果为同一个地址注册了多个处理程序, 则最后注册的处理程序将生效.

# I/O 调度

当 I/O 端口或 MMIO 访问被捕获时, ACRN Hypervisor 首先按照与注册相反的顺序遍历相应的 I/O 处理程序列表, 寻找合适的处理程序来模拟访问, 一般存在以下几种情况.

* 如果找到范围与 I/O 访问范围重叠的处理程序:

  * 如果 I/O 访问的范围完全落在处理程序可以模拟的范围内, 则调用该处理程序;

  * 否则说明访问不合法, 此时, 不会调用处理程序, 也不会将 I/O 请求传递给服务虚拟机. I/O 读取全为 1,I/O 写入被丢弃.

* 如果 I/O 访问的范围与处理程序的任何范围都不重叠, 则 I/O 访问将作为 I/O 请求被传递给服务虚拟机以进行进一步处理.
