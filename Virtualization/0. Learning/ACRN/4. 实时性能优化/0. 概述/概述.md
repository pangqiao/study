
本章将介绍嵌入式虚拟化软件运行在实时场景下必须支持的一个关键特征, 即实时性. 嵌入式系统的一个重要应用领域就是各种实时场景, 如常见的各种通信系统 (手机, 基站, 交换机等)​, 在各种交通工具(飞机, 火车, 汽车等) 上运行的控制系统, 以及工业领域的各种控制系统等. 在工业控制领域, 实时性则是一项基本要求. 虚拟化技术本身是在传统的嵌入式硬件和软件操作系统之间加了一个软件层, 因此它增加了程序执行的路径, 理论上对实时性是不友好的. 本章将探讨嵌入式虚拟化技术如何支持实时性, 以及如何在此环境下对实时性进行调优.

本章以 ACRN 在工业控制领域的应用为例, 介绍 ACRN 专门为支持实时性所做的架构工作, 通用的实时优化准则和策略, 以及 ACRN 的优化实现和一些辅助调优的增强功能 / 工具.

本章介绍了嵌入式虚拟化实时场景中 ACRN 如何支持实时性及其调优. 结合 Intel 硬件平台和 ACRN 列出了可行的基本思路来进行实时性能优化, 从而可以使 RTVM 的实时性接近于物理机的实时性. 这些思路包括:

* 尽量减少由虚拟化环境带来的实时性能开销. 常见的优化方法有 CPU 分区, 中断直通, 设备直通等. 这些方法可以使 RTVM 运行时不需要陷入 Hypervisor 这一层, 从而避免 VM Exit 的产生, 进而提高 RTVM 的性能.

* 利用 CAT 可以避免多个 VM 系统间的**访问缓存干扰**. 在**负载整合**的环境下, 一个硬件平台要同时支持 **RTVM** 和**非实时 VM**(例如 HMI)​, 因此**对缓存进行分区**可以有效提高 RTVM 的指令读取缓存的命中率, 进而提高其确定性和实时性. Intel **TCC** 工具可以用来辅助优化实时性能.

* 除了从 ACRN Hypervisor 和硬件层次配置优化之外, 还需要从 RTVM 中来配合调优. 例如, 在实时任务运行的过程中避免执行一些特殊指令 (如 CPUID)​, 访问一些特殊 MSR 等, 可以用 VM Exit 辅助工具来分析这些场景, 从 RTVM 中来避免这种情况的发生.
