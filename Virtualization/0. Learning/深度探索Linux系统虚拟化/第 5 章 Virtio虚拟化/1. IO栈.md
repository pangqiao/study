
# 说明

半虚拟化需要对 **Guest 中的驱动**和 **Host 中的模拟设备**进行改造, 需要将**基于物理设备的数据传输方式**按照 **Virtio 协议**进行组织. 

因此, 我们只有非常了解 **I/O 数据**在 **I/O 栈**的各个层次中是**如何表示**的, 才能更好地理解 **Guest** 中的 **Virtio 驱动**是如何将**上层**传递给其的**数据**按照 **Virtio 协议**组织并**传递**给**模拟设备**的, 以及 **Host** 中的**模拟设备**是**如何解析**接收到的数据并**完成模拟**的. 因此, 这一节首先来讨论内核的 I/O 栈. 

# 文件系统

I/O 栈的**第一层**是**文件系统**, 其**向上**需为**应用程序**提供**面向字节流**的访问**接口**, 向下需负责字节流和底层块设备之间的转换. 因为文件系统构建于块设备之上, 所以通常文件系统也使用块作为存储数据的基本结构, 这里的块指的是文件系统层面的数据结构, 不是指物理磁盘上的块, 在后面的"通用块层"一节中我们会具体讨论文件系统层面的块和物理磁盘扇区的关系. 一个文件的内容存储在多个块中, 为了可以动态调整文件大小, 并且避免文件系统中产生碎片, 一个文件内容所在的块并不是连续的. 



# 通用块层


# 块设备驱动

# page cache


# bio


# I/O 调度器

假设硬盘某个磁头在86柱面, 接下来的I/O request依次在如下柱面: 160、52、122、10、135、68、178. 如果我们按照FCFS(先来先服务)的策略来调度, 则磁头移动的轨迹如图5-6所示. 

我们看到磁头移动有很多迂回. 为了提高I/O效率, 通用块层引入了I/O调度, 对硬盘访问进行优化. 其中一种典型的I/O调度算法就是使用电梯调度算法对请求进行排队, 减少磁头寻道的距离. 采用电梯调度算法, 磁头移动的轨迹变化如图5-7所示, 可以看到, 磁头移动的距离减少了很多. 

