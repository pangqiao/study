
# 简介

基本输入输出系统(Basic InputOutput System, BIOS)是计算机启动后运行的第一个软件. BIOS的主要作用是初始化一些硬件, 为操作系统的运行做准备, 从而引导设备启动操作系统.

BIOS完成的主要任务如下. 

1) 上电自检(Power On Self Test, POST)指的是BIOS针对计算器硬件(如CPU、主板、存储器等)进行检测. 

2) POST之后初始化与启动相关的硬件(磁盘、键盘控制器等). 

3) 为操作系统创建一些参数, 比如ACPI表. 

4) 选择引导设备, 从设备中加载bootloader, 进而启动操作系统. 

SeaBIOS是开源的16位x86 BIOS的实现. SeaBIOS能够运行在模拟器中或者在使用coreboot的情况下运行在物理x86硬件上, 是QEMU/KVM虚拟化方案的默认BIOS. 从QEMU让CPU开始运行到实际的虚拟机操作内核开始运行, 中间有一个很重要的任务就是执行SeaBIOS的代码. 

相比于实际的物理BIOS, SeaBIOS的功能简单很多, 因为虚拟化环境中并不存在实际的物理硬件, 很多硬件配置可以省略, SeaBIOS只需要关注一些功能接口即可. SeaBIOS是QEMU运行虚拟机的第一部分代码, 理解SeaBIOS的工作原理, 对于理解QEMU和KVM虚拟化方案以及排查一些疑难问题都非常有帮助. 本节后面会首先介绍QEMU对SeaBIOS的加载, 之后会对SeaBIOS的代码流程进行简单讲解. 

# QEMU 加载 SeaBIOS

`pc_i440fx_machine_options` 会设置QEMU的firmware为biso-256k.bin, 代码如下.

`pc_i440fx_machine_options` 会在虚拟机注册QEMU虚拟机机器类型的时候调用, 这是由宏 `DEFINE_PC_MACHINE` 指定的. 

```cpp
// hw/i386/pc_piix.c
static void pc_i440fx_machine_options(MachineClass *m)
{
    PCMachineClass *pcmc = PC_MACHINE_CLASS(m);
    ObjectClass *oc = OBJECT_CLASS(m);
    pcmc->default_south_bridge = TYPE_PIIX3_DEVICE;
    pcmc->pci_root_uid = 0;
    pcmc->default_cpu_version = 1;

    m->family = "pc_piix";
    m->desc = "Standard PC (i440FX + PIIX, 1996)";
    m->default_machine_opts = "firmware=bios-256k.bin";
    m->default_display = "std";
    m->default_nic = "e1000";
    m->no_parallel = !module_object_class_by_name(TYPE_ISA_PARALLEL);
    machine_class_allow_dynamic_sysbus_dev(m, TYPE_RAMFB_DEVICE);
    machine_class_allow_dynamic_sysbus_dev(m, TYPE_VMBUS_BRIDGE);

    object_class_property_add_enum(oc, "x-south-bridge", "PCSouthBridgeOption",
                                   &PCSouthBridgeOption_lookup,
                                   pc_get_south_bridge,
                                   pc_set_south_bridge);
    object_class_property_set_description(oc, "x-south-bridge",
                                     "Use a different south bridge than PIIX3");
}
```