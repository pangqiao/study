
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 南桥的江湖地位问题](#1-南桥的江湖地位问题)
* [2 为什么不是SOC](#2-为什么不是soc)
* [3 什么是HSIO？](#3-什么是hsio)
* [4 DMI的带宽问题](#4-dmi的带宽问题)
* [5 结论](#5-结论)
* [6 参考](#6-参考)

<!-- /code_chunk_output -->

南桥芯片这个统管外部IO的芯片组正在逐步变得面目可憎起来. 经历了ICH到PCH的转变越来越多的人都在质疑它的存在. 为什么不把PCH集成进CPU中？**DMI 4个lane**的小水管下面带那么多PCIe root port加各种USB 3.0/3.1和SATA port会不会肠梗阻？今天我们一起来分析一下这么做背后深层次的原因. 

# 1 南桥的江湖地位问题

熟悉计算机系统演变历史的小伙伴们都知道. 很久很久以前(也没有多久了)计算机主板上有**CPU**、**北桥(MCH**)和**南桥(ICH**)这三个主要的芯片: 

![](./images/2019-04-22-16-59-59.png)

由于**FSB**变成了**系统效能的瓶颈**和**对多CPU的制约**在**台式机**和**笔记本**电脑中**MCH**被请进**CPU中****服务器**市场虽然短暂的出现了**IOH**但也慢慢的**被CPU吞噬**. 

前后简单的对比:

![](./images/2019-04-22-17-01-31.png)

注: 上面的是Intel G45和Intel H55芯片组

**CPU中MCH原来的部分(！！！**), 在**桌面CPU**中叫做System Agent(SA), 在**服务器CPU**中叫做**uncore(和内核core对应**). 它基本还负责原来的功能, 那就是 **内存管理(！！！内存控制器在CPU里面？？？**) 和提供 **至少16个Lane** 的**PCIe Root port(！！！RC在CPU里面？？**)来驱动**显卡！！！**(服务器uncore还包括QPI). 

这绝不是表面看起来“换个马甲”这么简单. 脱离了**FSB这条小细管道****内存控制器**、**PICe Root Port的root complex**和**内核**之间的通信变成了**ring bus**乃至**目前的Mesh网络**这种**片内总线**羊肠小路变成了高速公路. 如此改变让原来的瓶颈消失了计算机效能才在酷睿后有了质的飞跃. 

作为统管大部分IO设备的江湖大佬ICH到PCH的转变却十分的小时至今日除了**DMI**随着**PCIe 3.0**升级到**DMI 3.0**和增加了更多的功能外变化相对较小. 很多人看他不顺眼欲除之而后快让江湖最后一个大佬CPU一统主板. 

如果也把**PCH整合进CPU****单芯片解决方案！！！**也就是**SOC(System On a Chip！！！**)会带来很多好处: 

- 主板可以更便宜. 少一块芯片的钱主板设计简单一些线路少些这些都会帮助主板成本下降. 
- **南桥的设备**可以摆脱**DMI 3.0 8Gbps \* 4**的带宽限制. 如果我们把PCH中高速的USB 3.0/3.1 SATA ports和PCIe root ports提供的带宽都加在一起我们就会发现这个数字会远远高于DMI 3.0能够提供的带宽. 如果将南桥整合进CPU这些设备也就可以和原北桥的PCIe root port一样接入IOSF骨干bus摆脱DMI小水管. 

# 2 为什么不是SOC

现实中我们除了看到**ATOM系列全部是SOC**、部分低端入门系列服务器是SOC(它原因比较有趣我们今后再说)外绝大部分主流系统PCH还是傲娇地继续战斗在第一线. 这是为什么呢？

有两个原因十分明显: 

- 集成进PCH会造成**CPU Die增大不少**从而造成CPU良率下降很多成本增加明显. 这里有一篇讨论Die大小和良率的文章: [CPU制造的那些事之二: Die的大小和良品率](https://zhuanlan.zhihu.com/p/29767262)
- **PCH和CPU松耦合**从而CPU和PCH可以单独生产采用不同的工艺. 实际上**CPU**往往采用**最新的制程**而**PCH**往往使用**前期的制程**. 

还有一个十分重要的原因也许是最重要的原因往往不被人所知那就是**CPU的引脚pin不够用了**！

如果我们看现在的CPU引脚因为内存channel的不断增加和一些新的功能LGA封装的引脚不断增加一千多个引脚密密麻麻蔚为壮观. 随便增加引脚会带来CPU兼容性的问题Intel花了很大力气才能基本保证2年的引脚不变而AMD则为了保证4年引脚兼容性更付出了巨大的代价个中原因我们今后再讲. 

如果我们再看**PCH的引脚**就会发现它比CPU还要糟糕. 

- 几乎所有**低速的引脚**都**被复用**了某些引脚甚至有三到四个功能！需要**BIOS来选择(通过MUX**). 

- **高速引脚**通过**HSIO**也被**复用**. 

如果**PCH被整合到CPU**中会给引脚问题带来灾难性的后果而主板因为引脚的急剧增加也对工艺和稳定性带来负面影响. 

# 3 什么是HSIO？

**PCH的引脚**就那么多而人们对**高速设备**尤其是**USB host**和**PCIe root port**的需求却越来越大. 在所有低速引脚已经被充分挖潜而**低速引脚**和**高速引脚不能复用**(想想看为什么)的前提下如何提供**更多的高速设备**同时**尽可能不很快增加引脚数量**的问题被提上日程. 

在引入Flex IO后逐渐在所有PCH甚至ATOM SOC上HSIO被作为一种高速设备复用技术被集成进入芯片中: 

Denverton microserver SOC:

![](./images/2019-04-22-17-35-09.png)

每一路HSIO Lane提供8 Gbps的带宽. 内部的PCIe/USB/SATA设备控制器通过一层HSIO映射关系表对应到外部引脚上: 

![](./images/2019-04-22-17-35-33.png)

譬如我们可以将HSIO \#10选择连接到USB 3.0 \#10上或者是PCIe \#4上甚至是GBe(PCH集成网卡). 如此这般给了主板厂商很大的自由度让主板厂商根据主板的实际情况自由选择要多少PCIe多少USB或者SATA. 

另外需要澄清的是DMI并不在HSIO中. 

# 4 DMI的带宽问题

DMI 3.0 4 × 8Gbps怎么带动这么多的高速IO?我们上图中有30个HSIO每个支持8Gbps如果他们都接上设备会不会在DMI上造成拥堵？

当然会不过在普通的台式机上这个问题不是很严重而在高端台式机和服务器上是通过高端PCH提供的uplink直连CPU来解决的. 你看的没错PCH也有很多种高端PCH甚至HSIO都会多一些. 借用一句《动物庄园》里的话: 

所有PCH生来平等但贵的PCH更平等一些. 

# 5 结论

引脚的稀缺性很多人都没有意识到. 于此同理HSIO资源也是稀缺的每升级一代PCH就会提供更多的HSIO来提供更多的USB port因为现在越来越多的人选择M.2 NvME SSDPCIe root port也捉襟见肘起来. 更多的HSIO可以让主板厂商有更多的腾挪和发挥空间. 

最后给大家两个思考题Coffeelake CPU引脚图如下: 

![](./images/2019-04-23-09-03-17.png)

Kabylake CPU:

![](./images/2019-04-23-09-03-33.png)

1. 说引脚不够用为什么电源和地占据了几乎一半引脚？
2. 同样1151 socket从Kabylake到Coffeelake什么变了为什么？


# 6 参考

- 本文章来自于: https://zhuanlan.zhihu.com/p/47479121
- 问题1答案在: [CPU底部的小块是干什么用的？为什么CPU这么多电源引脚？](https://zhuanlan.zhihu.com/p/48593932)