
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1 x86平台的常用时钟](#1-x86平台的常用时钟)
  - [PIT可编程中断时钟](#pit可编程中断时钟)
- [2 操作系统的时钟观](#2-操作系统的时钟观)

<!-- /code_chunk_output -->

现代计算机中, 操作系统中很多事件都是时钟驱动的, 例如进程调度、定时器等.

时钟根据**工作方式**不同, 可以分为如下两类.

⓵ **周期性时钟**(Periodic Timer): 时钟以固定频率产生时钟中断. 通常, 周期性时钟会有一个计数器, 要么以固定值递减到0产生中断, 例如PIT; 要么固定增长, 当达到某个阙值时产生中断, 同时自动将阙值增加一个固定值, 计数器继续递增, 例如HPET.

⓶ **单次计时时钟**(One\-shot Timer): 多数时钟都可以配置成这种方式, 例如PIT、HPET. 其工作方式和**到达阙值产生中断的周期性时钟**类似, 不同的是**产生中断后阙值不会自动增加**, 而是需要软件(通常是时钟中断处理函数)增加该阙值. 这提供给软件动态调整下一次时钟中断到来时间的能力, 使一些新技术,例如无滴答声内核(Tickles Kernel)的实现成为可能.

# 1 x86平台的常用时钟

由于历史原因, x86平台有多种时钟, 目前仍广泛使用的有以下几种.

## PIT可编程中断时钟

(1) **PIT**: Programmable Interrupt Timer或Programmable Interval Timer, **可编程中断/间隔时钟**

IBM PC平台产生, 频率为**1000Hz左右**, 即**每次中断间隔约为1ms**, 通常接**IRQ0**产生**周期性的时钟中断信号**来充当**系统定时器**, 软件可以通过`0x40~0x43 I/O`端口进行操作. 

PIT是一种低精度的时钟, 容易溢出(16位), 已渐渐被高精度时钟取代.

PIT支持周期性和单次计时两种方式.

8254 PIT有**3个计时通道**, 每个通道都有其不同的用途:

- **通道0**用来负责**更新系统时钟**. 它在**每个时钟滴答**会通过**IRQ0**向系统发出一次**时钟中断信号**.
- **通道1**通常用来控制**DMAC对RAM的刷新**
- **通道3**被连接到**PC机的扬声器**, 以产生**方波信号**.

(2) **RTC(Real Time Clock, 实时时钟**): 通常**和CMOS集成**在一起, 由**CMOS电池供电**, 故能在**关机后继续计时**. 其频率范围是2\~8192Hz, 通常接**IRQ8**, 软件可以通过**0x70\~0x71 I/O端口**操作. RTC支持周期性和单次计时两种方式, 此外, 它还可以配置成**每秒产生一次中断**, 具有闹钟功能. 由于具有关机继续计时的功能, RTC常被用来作为操作系统提供日期. 即"年/月/日".

(3) **TSC(Time Stamp Counter, 时间戳计数器**): 和普通时钟不同, 可以看作一个**单调递增的计数器(64位**), 是由x86架构引入的. 其时钟频率和CPU的频率相关, 操作系统在使用前**需要计算其频率**, 例如1GHz的TSC, 其值每纳秒增加1. 通过**rdtsc**指令, 可以读取**当前TSC的值**. 由于不产生时钟中断, 故无所谓周期性和单次计时方式.

(4) **LAPIC Timer**: 该时钟是根据LAPIC所在总线(系统总线或APIC总线)频率产生的. 为32位, 有如下两个特点.

⓵ 由于LAPIC是每个CPU一个, 故其中断也是对于本地CPU的(Per CPU Interrupt).

⓶ 可通过寄存器配置, 对总线周期进行不同的分频而产生不同频率的时钟中断.

LAPIC Timer可配置成周期性和单次计时两种工作方式.

(5) **HPET**(High Precision Event Timer, 高精度时间时钟): Intel和微软共同开发的新型高精度时钟, 最低频率10MHz, 可作为64位或32位时钟使用. HPET可以提供最多8个时钟, 典型实现至少有一个时钟可用. HPET时钟通过一个主计数器, 和32个比较器、匹配器一起, 又可以被配置成32个子时钟(又称channel), 每个子时钟可按不同频率产生不同的中断. 例如, 可将一个子时钟配置成每毫秒产生一个IRQ8中断, 另一个子时钟可配置成每毫秒产生一个IRQ0中断. HPET可用于代替传统PIT和RTC, 此时平台的IRQ0、IRQ8中断被HPET占用。 HPET支持周期性和单次计时两种工作方式。

同时使用多个时钟带来一个明显缺点是**过多时钟中断会影响系统的性能(！！！**). 所以, 当高精度时钟可用, **OS通常会禁用低精度时钟(！！！**), 并根据需要使用**高精度时钟模拟低精度时钟**.

# 2 操作系统的时钟观

从操作系统角度看, 时钟作用可以分为如下两类.

⓵ 提供**统计值**及**驱动事件**: 

- 提供**统计值**是指操作系统用时钟来**维护一些必需的数据**, 例如一个**进程**在**用户态/内核态的时间**, 系统的日期、时间等. 
- **驱动事件**是指**驱动以时间为资源的程序！！！**, 典型就是进程. 例如, 分时操作系统为**每个进程分配固定的时间片**, 调度时间片耗尽的进程睡眠, 唤醒分配到新时间片的进程运行.

⓶ **维护定时器(Timer**): 定时器是程序中常用的组件, 用于在某个指定时间到达后执行特定的操作. 定时器大量运用于操作系统中, 例如内核为I/O操作注册的超时定时器、操作系统提供给应用程序使用的定时器接口等. 见图2\-19.

![](./images/2019-07-01-17-41-22.png)

图中可看到, 操作系统使用时钟的功能, 是以时钟中断为基础的. 要了解时钟的作用, 可以以时钟中断为脉络, 勾画出整个框图.

操作系统往往会对时钟架构进行封装以方便维护和使用. 但从**硬件角度**看, 时钟中断仍然是所有封装的基础, 故**虚拟化**中**对时钟的处理**主要是提供**准确的时钟中断**以**模拟硬件**的行为.