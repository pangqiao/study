PCI 总线作为处理器系统的局部总线主要目的是**为了连接外部设备**而**不是作为处理器的系统总线连接 Cache 和主存储器**. 但是 PCI 总线、系统总线和处理器体系结构之间依然存在着紧密的联系.

PCI 总线作为系统总线的延伸其设计考虑了许多与处理器相关的内容如处理器的 Cache 共享一致性和数据完整性以及如何与处理器进行数据交换等一系列内容. 其中 Cache 共享一致性和数据完整性是现代处理器局部总线的设计的重点和难点也是本书将重点讲述的主题之一.

独立地研究 PCI 总线并不可取因为 PCI 总线仅是处理器系统的一个组成部分. 深入理解 PCI 总线需要了解一些与处理器体系结构相关的知识. 这些知识是本书所侧重描述的同时也是 PCI 总线规范所忽略的内容. 脱离实际的处理器系统不容易也不可能深入理解 PCI 总线规范.

对于今天的读者来说 PCI 总线提出的许多概念略显过时也有许多不足之处. 但是在当年 PCI 总线与之前的存在其他并行局部总线如 ISA、EISA 和 MCA 总线相比具有许多突出的优点是一个全新的设计.

(1) PCI 总线空间与处理器空间隔离

PCI 设备具有独立的地址空间即**PCI 总线地址空间该空间与存储器地址空间通过 HOST 主桥隔离**. **处理器需要通过 HOST 主桥才能访问 PCI 设备**而**PCI 设备需要通过 HOST 主桥才能访问主存储器**. 在 HOST 主桥中含有许多缓冲这些缓冲使得处理器总线与 PCI 总线工作在各自的时钟频率中彼此互不干扰. HOST 主桥的存在也使得 PCI 设备和处理器可以方便地共享主存储器资源.

**处理器访问 PCI 设备**时必须**通过 HOST 主桥进行地址转换**; 而**PCI 设备访问主存储器**时也需要**通过 HOST 主桥进行地址转换**. HOST 主桥的一个重要作用就是**将处理器访问的存储器地址转换为 PCI 总线地址**. PCI 设备使用的地址空间是属于 PCI 总线域的而与存储器地址空间不同.

x86 处理器对 PCI 总线域与存储器域的划分并不明晰这也使得许多程序员并没有准确地区分 PCI 总线域地址空间与存储器域地址空间. 而本书将反复强调存储器地址和 PCI 总线地址的区别因为这是理解 PCI 体系结构的重要内容.

PCI 规范并没有对 HOST 主桥的设计进行约束. 每一个处理器厂商使用的 HOST 主桥其设计都不尽相同. HOST 主桥是联系 PCI 总线与处理器的核心部件掌握 HOST 主桥的实现机制是深入理解 PCI 体系结构的前提.

本书将以 Freescale 的 PowerPC 处理器和 Intel 的 x86 处理器为例说明各自 HOST 主桥的实现方式值得注意的是本书涉及的 PowerPC 处理器仅针对 Freescale 的 PowerPC 处理器而不包含 IBM 和 AMCC 的 Power 和 PowerPC 处理器. 而且如果没有特别说明本书中涉及的 x86 处理器特指 Intel 的处理器而不是其他厂商的 x86 处理器.

(2) 可扩展性

PCI 总线具有很强的扩展性. 在 PCI 总线中**HOST 主桥可以直接推出一条 PCI 总线**这条总线也是该 HOST 主桥的所管理的第一条 PCI 总线该总线还可以通过 PCI 桥扩展出一系列 PCI 总线并以 HOST 主桥为根节点形成 1 颗 PCI 总线树. 这些 PCI 总线都可以连接 PCI 设备但是**在 1 颗 PCI 总线树上最多只能挂接 256 个 PCI 设备(包括 PCI 桥)**.

在**同一条 PCI 总线上的设备间可以直接通信**并不会影响其他 PCI 总线上设备间的数据通信. 隶属于同一颗 PCI 总线树上的 PCI 设备也可以直接通信但是需要通过 PCI 桥进行数据转发.

PCI 桥是 PCI 总线的一个重要组成部件该部件的存在使得 PCI 总线极具扩展性. PCI 桥也是有别于其他局部总线的一个重要部件. 在"以 HOST 主桥为根节点"的 PCI 总线树中每一个 PCI 桥下也可以连接一个 PCI 总线子树 PCI 桥下的 PCI 总线仍然可以使用 PCI 桥继续进行总线扩展.

PCI 桥可以管理这个 PCI 总线子树**PCI 桥的配置空间**含有一系列管理 PCI 总线子树的配置寄存器. 在 PCI 桥的两端分别连接了两条总线分别是上游总线(Primary Bus)和下游总线(Secondary Bus). 其中与处理器距离较近的总线被称为上游总线另一条被称为下游总线. 这两条总线间的通信需要通过 PCI 桥进行. PCI 桥中的许多概念被 PCIe 总线采纳理解 PCI 桥也是理解 PCIe 体系结构的基础.

(3) 动态配置机制

PCI 设备使用的地址可以根据需要由系统软件动态分配. PCI 总线使用这种方式合理地解决了设备间的地址冲突从而实现了"即插即用"功能. 从而 PCI 总线不需要使用 ISA 或者 EISA 接口卡为解决地址冲突而使用的硬件跳线.

每一个 PCI 设备都有独立的配置空间在配置空间中含有该设备在 PCI 总线中使用的基地址系统软件可以动态配置这个基地址从而保证每一个 PCI 设备使用的物理地址并不相同. PCI 桥的配置空间中含有其下 PCI 子树所能使用的地址范围.

(4) 总线带宽

PCI 总线与之前的局部总线相比极大提高了数据传送带宽 32 位/33MHz 的 PCI 总线可以提供 132MB/s 的峰值带宽而 64 位/66MHz 的 PCI 总线可以提供的峰值带宽为 532MB/s. 虽然 PCI 总线所能提供的峰值带宽远不能和 PCIe 总线相比但是与之前的局部总线 ISA、EISA 和 MCA 总线相比仍然具有较大的优势.

ISA 总线的最高主频为 8MHz 位宽为 16 其峰值带宽为 16MB/s; EISA 总线的最高主频为 8.33MHz 位宽为 32 其峰值带宽为 33MB/s; 而 MCA 总线的最高主频为 10MHz 最高位宽为 32 其峰值带宽为 40MB/s. PCI 总线提供的峰值带宽远高于这些总线.

(5) 共享总线机制

PCI 设备通过仲裁获得 PCI 总线的使用权后才能进行数据传送在 PCI 总线上进行数据传送并不需要处理器进行干预.

PCI 总线仲裁器不在 PCI 总线规范定义的范围内也不一定是 HOST 主桥和 PCI 桥的一部分. 虽然绝大多数 HOST 主桥和 PCI 桥都包含 PCI 总线仲裁器但是在某些处理器系统的设计中也可以使用独立的 PCI 总线仲裁器. 如在 PowerPC 处理器的 HOST 主桥中含有 PCI 总线仲裁器但是用户可以关闭这个总线仲裁器而使用独立的 PCI 总线仲裁器.

PCI 设备使用共享总线方式进行数据传递在同一条总线上所有 PCI 设备共享同一总线带宽这将极大地影响 PCI 总线的利用率. 这种机制显然不如 PCIe 总线采用的交换结构但是在 PCI 总线盛行的年代半导体的工艺、设计能力和制作成本决定了采用共享总线方式是当时的最优选择.

(6) 中断机制

PCI 总线上的设备可以通过四根中断请求信号 INTA~D#向处理器提交中断请求. 与 ISA 总线上的设备不同 PCI 总线上的设备可以共享这些中断请求信号不同的 PCI 设备可以将这些中断请求信号"线与"后与中断控制器的中断请求引脚连接. PCI 设备的配置空间记录了该设备使用这四根中断请求信号的信息.

PCI 总线进一步提出了 MSI(Message Signal Interrupt)机制该机制使用存储器写总线事务传递中断请求并可以使用 x86 处理器 FSB(Front Side Bus)总线提供的 Interrupt Message 总线事务从而提高了 PCI 设备的中断请求效率.

虽然从现代总线技术的角度上看 PCI 总线仍有许多不足之处但也不能否认 PCI 总线已经获得了巨大的成功不仅 x86 处理器将 PCI 总线作为标准的局部总线连接各类外部设备 PowerPC、MIPS 和 ARM[1]处理器也将 PCI 总线作为标准局部总线. 除此之外基于 PCI 总线的外部设备如以太网控制器、声卡、硬盘控制器等也已经成为主流.